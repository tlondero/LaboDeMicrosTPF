/*
 * Copyright (c) 2015, Freescale Semiconductor, Inc.
 * Copyright 2016-2019 NXP
 * All rights reserved.
 *
 * SPDX-License-Identifier: BSD-3-Clause
 */

#include "fsl_debug_console.h"
#include "board.h"
#include "fsl_pit.h"

#include "DAC_Wrapper.h"

#include "pin_mux.h"
#include "clock_config.h"
/*******************************************************************************
 * Definitions
 ******************************************************************************/
#define VOLUME_STEPS	  30
#define DEMO_PIT_BASEADDR PIT
#define DEMO_PIT_CHANNEL  kPIT_Chnl_0
#define PIT_LED_HANDLER   PIT0_IRQHandler
#define PIT_IRQ_ID        PIT0_IRQn
/* Get source clock for PIT driver */
#define PIT_SOURCE_CLOCK CLOCK_GetFreq(kCLOCK_BusClk)
#define LED_INIT()       LED_RED_INIT(LOGIC_LED_ON)
#define LED_TOGGLE()     LED_RED_TOGGLE()

/*******************************************************************************
 * Prototypes
 ******************************************************************************/

/*******************************************************************************
 * Variables
 ******************************************************************************/

volatile bool pitIsrFlag = false;

float volume[VOLUME_STEPS] = { 0.00f, 0.05f, 0.10f, 0.15f, 0.20f, 0.25f, 0.30f,
		0.35f, 0.40f, 0.45f, 0.50f, 0.55f, 0.60f, 0.65f, 0.70f, 0.75f, 0.80f,
		0.85f, 0.90f, 0.95f, 1.00f, 1.05f, 1.10f, 1.15f, 1.20f, 1.25f, 1.30f,
		1.35f, 1.40f, 1.45f };

uint16_t sen1k[DAC_USED_BUFFER_SIZE] = { 2047U, 2060U, 2072U, 2085U, 2097U,
		2110U, 2122U, 2135U, 2148U, 2160U, 2173U, 2185U, 2198U, 2210U, 2223U,
		2235U, 2248U, 2260U, 2273U, 2285U, 2298U, 2310U, 2323U, 2335U, 2348U,
		2360U, 2373U, 2385U, 2397U, 2410U, 2422U, 2434U, 2447U, 2459U, 2471U,
		2484U, 2496U, 2508U, 2521U, 2533U, 2545U, 2557U, 2569U, 2581U, 2594U,
		2606U, 2618U, 2630U, 2642U, 2654U, 2666U, 2678U, 2690U, 2702U, 2714U,
		2726U, 2737U, 2749U, 2761U, 2773U, 2785U, 2796U, 2808U, 2820U, 2831U,
		2843U, 2854U, 2866U, 2877U, 2889U, 2900U, 2912U, 2923U, 2935U, 2946U,
		2957U, 2968U, 2980U, 2991U, 3002U, 3013U, 3024U, 3035U, 3046U, 3057U,
		3068U, 3079U, 3090U, 3101U, 3111U, 3122U, 3133U, 3143U, 3154U, 3165U,
		3175U, 3186U, 3196U, 3206U, 3217U, 3227U, 3237U, 3247U, 3258U, 3268U,
		3278U, 3288U, 3298U, 3308U, 3318U, 3327U, 3337U, 3347U, 3357U, 3366U,
		3376U, 3385U, 3395U, 3404U, 3414U, 3423U, 3432U, 3442U, 3451U, 3460U,
		3469U, 3478U, 3487U, 3496U, 3505U, 3514U, 3522U, 3531U, 3540U, 3548U,
		3557U, 3565U, 3574U, 3582U, 3590U, 3599U, 3607U, 3615U, 3623U, 3631U,
		3639U, 3647U, 3655U, 3662U, 3670U, 3678U, 3685U, 3693U, 3700U, 3708U,
		3715U, 3722U, 3729U, 3736U, 3744U, 3751U, 3757U, 3764U, 3771U, 3778U,
		3785U, 3791U, 3798U, 3804U, 3811U, 3817U, 3823U, 3830U, 3836U, 3842U,
		3848U, 3854U, 3860U, 3865U, 3871U, 3877U, 3882U, 3888U, 3893U, 3899U,
		3904U, 3909U, 3915U, 3920U, 3925U, 3930U, 3935U, 3940U, 3944U, 3949U,
		3954U, 3958U, 3963U, 3967U, 3971U, 3976U, 3980U, 3984U, 3988U, 3992U,
		3996U, 4000U, 4003U, 4007U, 4011U, 4014U, 4018U, 4021U, 4024U, 4028U,
		4031U, 4034U, 4037U, 4040U, 4043U, 4045U, 4048U, 4051U, 4053U, 4056U,
		4058U, 4060U, 4063U, 4065U, 4067U, 4069U, 4071U, 4073U, 4075U, 4076U,
		4078U, 4079U, 4081U, 4082U, 4084U, 4085U, 4086U, 4087U, 4088U, 4089U,
		4090U, 4091U, 4092U, 4092U, 4093U, 4093U, 4094U, 4094U, 4094U, 4094U,
		4094U, 4095U, 4094U, 4094U, 4094U, 4094U, 4093U, 4093U, 4092U, 4092U,
		4091U, 4090U, 4090U, 4089U, 4088U, 4087U, 4086U, 4084U, 4083U, 4082U,
		4080U, 4079U, 4077U, 4075U, 4074U, 4072U, 4070U, 4068U, 4066U, 4064U,
		4062U, 4059U, 4057U, 4054U, 4052U, 4049U, 4047U, 4044U, 4041U, 4038U,
		4035U, 4032U, 4029U, 4026U, 4023U, 4019U, 4016U, 4012U, 4009U, 4005U,
		4002U, 3998U, 3994U, 3990U, 3986U, 3982U, 3978U, 3974U, 3969U, 3965U,
		3960U, 3956U, 3951U, 3947U, 3942U, 3937U, 3932U, 3927U, 3922U, 3917U,
		3912U, 3907U, 3902U, 3896U, 3891U, 3885U, 3880U, 3874U, 3868U, 3863U,
		3857U, 3851U, 3845U, 3839U, 3833U, 3826U, 3820U, 3814U, 3807U, 3801U,
		3795U, 3788U, 3781U, 3775U, 3768U, 3761U, 3754U, 3747U, 3740U, 3733U,
		3726U, 3718U, 3711U, 3704U, 3696U, 3689U, 3681U, 3674U, 3666U, 3658U,
		3651U, 3643U, 3635U, 3627U, 3619U, 3611U, 3603U, 3594U, 3586U, 3578U,
		3569U, 3561U, 3552U, 3544U, 3535U, 3527U, 3518U, 3509U, 3500U, 3491U,
		3483U, 3474U, 3464U, 3455U, 3446U, 3437U, 3428U, 3418U, 3409U, 3400U,
		3390U, 3381U, 3371U, 3362U, 3352U, 3342U, 3332U, 3323U, 3313U, 3303U,
		3293U, 3283U, 3273U, 3263U, 3253U, 3242U, 3232U, 3222U, 3212U, 3201U,
		3191U, 3180U, 3170U, 3159U, 3149U, 3138U, 3127U, 3117U, 3106U, 3095U,
		3084U, 3073U, 3063U, 3052U, 3041U, 3030U, 3019U, 3008U, 2996U, 2985U,
		2974U, 2963U, 2952U, 2940U, 2929U, 2918U, 2906U, 2895U, 2883U, 2872U,
		2860U, 2849U, 2837U, 2825U, 2814U, 2802U, 2790U, 2779U, 2767U, 2755U,
		2743U, 2732U, 2720U, 2708U, 2696U, 2684U, 2672U, 2660U, 2648U, 2636U,
		2624U, 2612U, 2600U, 2588U, 2575U, 2563U, 2551U, 2539U, 2527U, 2514U,
		2502U, 2490U, 2478U, 2465U, 2453U, 2441U, 2428U, 2416U, 2404U, 2391U,
		2379U, 2366U, 2354U, 2342U, 2329U, 2317U, 2304U, 2292U, 2279U, 2267U,
		2254U, 2242U, 2229U, 2217U, 2204U, 2192U, 2179U, 2166U, 2154U, 2141U,
		2129U, 2116U, 2104U, 2091U, 2078U, 2066U, 2053U, 2041U, 2028U, 2016U,
		2003U, 1990U, 1978U, 1965U, 1953U, 1940U, 1928U, 1915U, 1903U, 1890U,
		1877U, 1865U, 1852U, 1840U, 1827U, 1815U, 1802U, 1790U, 1777U, 1765U,
		1752U, 1740U, 1728U, 1715U, 1703U, 1690U, 1678U, 1666U, 1653U, 1641U,
		1629U, 1616U, 1604U, 1592U, 1580U, 1567U, 1555U, 1543U, 1531U, 1519U,
		1506U, 1494U, 1482U, 1470U, 1458U, 1446U, 1434U, 1422U, 1410U, 1398U,
		1386U, 1374U, 1362U, 1351U, 1339U, 1327U, 1315U, 1304U, 1292U, 1280U,
		1269U, 1257U, 1245U, 1234U, 1222U, 1211U, 1199U, 1188U, 1176U, 1165U,
		1154U, 1142U, 1131U, 1120U, 1109U, 1098U, 1086U, 1075U, 1064U, 1053U,
		1042U, 1031U, 1021U, 1010U, 999U, 988U, 977U, 967U, 956U, 945U, 935U,
		924U, 914U, 903U, 893U, 882U, 872U, 862U, 852U, 841U, 831U, 821U, 811U,
		801U, 791U, 781U, 771U, 762U, 752U, 742U, 732U, 723U, 713U, 704U, 694U,
		685U, 676U, 666U, 657U, 648U, 639U, 630U, 620U, 611U, 603U, 594U, 585U,
		576U, 567U, 559U, 550U, 542U, 533U, 525U, 516U, 508U, 500U, 491U, 483U,
		475U, 467U, 459U, 451U, 443U, 436U, 428U, 420U, 413U, 405U, 398U, 390U,
		383U, 376U, 368U, 361U, 354U, 347U, 340U, 333U, 326U, 319U, 313U, 306U,
		299U, 293U, 287U, 280U, 274U, 268U, 261U, 255U, 249U, 243U, 237U, 231U,
		226U, 220U, 214U, 209U, 203U, 198U, 192U, 187U, 182U, 177U, 172U, 167U,
		162U, 157U, 152U, 147U, 143U, 138U, 134U, 129U, 125U, 120U, 116U, 112U,
		108U, 104U, 100U, 96U, 92U, 89U, 85U, 82U, 78U, 75U, 71U, 68U, 65U, 62U,
		59U, 56U, 53U, 50U, 47U, 45U, 42U, 40U, 37U, 35U, 32U, 30U, 28U, 26U,
		24U, 22U, 20U, 19U, 17U, 15U, 14U, 12U, 11U, 10U, 8U, 7U, 6U, 5U, 4U,
		4U, 3U, 2U, 2U, 1U, 1U, 0U, 0U, 0U, 0U, 0U, 0U, 0U, 0U, 0U, 0U, 1U, 1U,
		2U, 2U, 3U, 4U, 5U, 6U, 7U, 8U, 9U, 10U, 12U, 13U, 15U, 16U, 18U, 19U,
		21U, 23U, 25U, 27U, 29U, 31U, 34U, 36U, 38U, 41U, 43U, 46U, 49U, 51U,
		54U, 57U, 60U, 63U, 66U, 70U, 73U, 76U, 80U, 83U, 87U, 91U, 94U, 98U,
		102U, 106U, 110U, 114U, 118U, 123U, 127U, 131U, 136U, 140U, 145U, 150U,
		154U, 159U, 164U, 169U, 174U, 179U, 185U, 190U, 195U, 201U, 206U, 212U,
		217U, 223U, 229U, 234U, 240U, 246U, 252U, 258U, 264U, 271U, 277U, 283U,
		290U, 296U, 303U, 309U, 316U, 323U, 330U, 337U, 343U, 350U, 358U, 365U,
		372U, 379U, 386U, 394U, 401U, 409U, 416U, 424U, 432U, 440U, 447U, 455U,
		463U, 471U, 479U, 487U, 495U, 504U, 512U, 520U, 529U, 537U, 546U, 554U,
		563U, 572U, 580U, 589U, 598U, 607U, 616U, 625U, 634U, 643U, 652U, 662U,
		671U, 680U, 690U, 699U, 709U, 718U, 728U, 737U, 747U, 757U, 767U, 776U,
		786U, 796U, 806U, 816U, 826U, 836U, 847U, 857U, 867U, 877U, 888U, 898U,
		908U, 919U, 929U, 940U, 951U, 961U, 972U, 983U, 993U, 1004U, 1015U,
		1026U, 1037U, 1048U, 1059U, 1070U, 1081U, 1092U, 1103U, 1114U, 1126U,
		1137U, 1148U, 1159U, 1171U, 1182U, 1194U, 1205U, 1217U, 1228U, 1240U,
		1251U, 1263U, 1274U, 1286U, 1298U, 1309U, 1321U, 1333U, 1345U, 1357U,
		1368U, 1380U, 1392U, 1404U, 1416U, 1428U, 1440U, 1452U, 1464U, 1476U,
		1488U, 1500U, 1513U, 1525U, 1537U, 1549U, 1561U, 1573U, 1586U, 1598U,
		1610U, 1623U, 1635U, 1647U, 1660U, 1672U, 1684U, 1697U, 1709U, 1721U,
		1734U, 1746U, 1759U, 1771U, 1784U, 1796U, 1809U, 1821U, 1834U, 1846U,
		1859U, 1871U, 1884U, 1896U, 1909U, 1921U, 1934U, 1946U, 1959U, 1972U,
		1984U, 1997U, 2009U, 2022U, 2034U, 2047U };

/*******************************************************************************
 * Code
 ******************************************************************************/

void PIT_LED_HANDLER(void) {
	/* Clear interrupt flag.*/
	PIT_ClearStatusFlags(DEMO_PIT_BASEADDR, DEMO_PIT_CHANNEL, kPIT_TimerFlag);
	pitIsrFlag = true;
	/* Added for, and affects, all PIT handlers. For CPU clock which is much larger than the IP bus clock,
	 * CPU can run out of the interrupt handler before the interrupt flag being cleared, resulting in the
	 * CPU's entering the handler again and again. Adding DSB can prevent the issue from happening.
	 */
	__DSB();
}

uint8_t cambio(uint8_t count);
uint8_t cambiosin(uint8_t count_);

int main(void) {
	/* Structure of initialize PIT */
	pit_config_t pitConfig;

	/* Board pin, clock, debug console init */
	BOARD_InitPins();
	BOARD_BootClockRUN();
	BOARD_InitDebugConsole();

	/* Initialize and enable LED */
	LED_INIT();

	DAC_Wrapper_Init();

	DAC_Wrapper_Start_Trigger();

	PIT_GetDefaultConfig(&pitConfig);
	PIT_Init(DEMO_PIT_BASEADDR, &pitConfig);
	PIT_SetTimerPeriod(DEMO_PIT_BASEADDR, DEMO_PIT_CHANNEL,
			USEC_TO_COUNT(1000000U, PIT_SOURCE_CLOCK));
	PIT_EnableInterrupts(DEMO_PIT_BASEADDR, DEMO_PIT_CHANNEL,
			kPIT_TimerInterruptEnable);
	EnableIRQ(PIT_IRQ_ID);
	PIT_StartTimer(DEMO_PIT_BASEADDR, DEMO_PIT_CHANNEL);

	uint16_t i, j;
	uint16_t xd = 0;

	uint16_t buffer[DAC_USED_BUFFER_SIZE] = { 0 };
	DAC_Wrapper_Loop(true);
	DAC_Wrapper_Set_Data_Array(&buffer, DAC_USED_BUFFER_SIZE);

	while (true) {
		for (i = 0; i < 30;) {
			/* Check whether occur interupt and toggle LED */

			for (j = 0; j < DAC_USED_BUFFER_SIZE; j++) {
				float xd_ = ( (float) i ) / 30.0;
				buffer[j] = (uint16_t) (sen1k[j] * xd_ );
			}

			if (true == pitIsrFlag) {
				LED_TOGGLE();
				pitIsrFlag = false;
				if (xd == 4) {
					xd = 0;
					float vol = i * 100.0 / 30.0;
					uint16_t vol_ = (uint16_t) (vol);
					printf("VOLUME = %d\n\n", vol_);
					i++;
				}
				xd++;
			}
		}
	}
}
