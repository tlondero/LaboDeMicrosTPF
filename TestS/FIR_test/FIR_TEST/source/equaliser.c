/***************************************************************************//**
  @file     equaliser.c
  @brief    ...
  @author   MAGT
 ******************************************************************************/

/*******************************************************************************
 * INCLUDE HEADER FILES
 ******************************************************************************/

#include "equaliser.h"
#include "arm_math.h"
#include "math_helper.h"

/*******************************************************************************
 * CONSTANT AND MACRO DEFINITIONS USING #DEFINE
 ******************************************************************************/

#define BLOCK_SIZE          32
#define NUM_TAPS            65


/*******************************************************************************
 *  VARIABLES WITH FILE LEVEL SCOPE
 ******************************************************************************/

static uint32_t eqFrameSize;
static uint32_t blockSize = BLOCK_SIZE;

static float32_t firStateF32[BLOCK_SIZE + NUM_TAPS - 1];      // State of the FIR filter. Needed for initialisation.

arm_fir_instance_f32 parallelFilter[EQ_NUM_OF_FILTERS];          // EQ filter implemented as parallel bandpass FIR filters.

static const float32_t eqFirCoeffs32[EQ_NUM_OF_FILTERS][NUM_TAPS] __attribute__((aligned(32))) =     // Coefficients of each bandpass FIR filter. Computed with MATLAB.
{
  {-0.00211319018958735f, 0.000522504513715403f, 0.00333067976351975f, 0.00606280079957187f, 0.00845640372554800f, 0.0102574800082125f, 0.0112437919673325f, 0.0112471890369089f, 0.0101729722850570f, 0.00801449706814228f, 0.00486150557289915f, 0.000901123320867192f, -0.00358899524266904f, -0.00825526923923513f, -0.0126898038361763f, -0.0164576740337862f, -0.0191280260950576f, -0.0203067588895859f, -0.0196683300037837f, -0.0169842035686679f, -0.0121456261736106f, -0.00517877569725478f, 0.00374914860513427f, 0.0143336759156845f, 0.0261467064385734f, 0.0386593500421349f, 0.0512725525963824f, 0.0633534850525292f, 0.0742751990709248f, 0.0834567663662373f, 0.0904010417753521f, 0.0947273306829633f, 0.0961965908106956f, 0.0947273306829633f, 0.0904010417753521f, 0.0834567663662373f, 0.0742751990709248f, 0.0633534850525292f, 0.0512725525963824f, 0.0386593500421349f, 0.0261467064385734f, 0.0143336759156845f, 0.00374914860513427f, -0.00517877569725478f, -0.0121456261736106f, -0.0169842035686679f, -0.0196683300037837f, -0.0203067588895859f, -0.0191280260950576f, -0.0164576740337862f, -0.0126898038361763f, -0.00825526923923513f, -0.00358899524266904f, 0.000901123320867192f, 0.00486150557289915f, 0.00801449706814228f, 0.0101729722850570f, 0.0112471890369089f, 0.0112437919673325f, 0.0102574800082125f, 0.00845640372554800f, 0.00606280079957187f, 0.00333067976351975f, 0.000522504513715403f, -0.00211319018958735f},
  {0.00986987182678594f, 0.00375869978760271f, -0.00457129264113444f, -0.0128727709618177f, -0.0186900441328536f, -0.0202202610795858f, -0.0169970908725220f, -0.0101255056328730f, -0.00194573242678950f, 0.00478843277933532f, 0.00794079641258116f, 0.00685558665059282f, 0.00270668808271615f, -0.00184680864818596f, -0.00363228133247420f, -0.000252994090977502f, 0.00876374817237083f, 0.0214123445499834f, 0.0335285914053441f, 0.0399735318503908f, 0.0363591033815006f, 0.0207672169018033f, -0.00513934147795827f, -0.0360648691876308f, -0.0642207061062206f, -0.0814034196311875f, -0.0814276758986877f, -0.0621715263756153f, -0.0265660997603516f, 0.0178441045244556f, 0.0607164225749483f, 0.0916190452185599f, 0.102861717242765f, 0.0916190452185599f, 0.0607164225749483f, 0.0178441045244556f, -0.0265660997603516f, -0.0621715263756153f, -0.0814276758986877f, -0.0814034196311875f, -0.0642207061062206f, -0.0360648691876308f, -0.00513934147795827f, 0.0207672169018033f, 0.0363591033815006f, 0.0399735318503908f, 0.0335285914053441f, 0.0214123445499834f, 0.00876374817237083f, -0.000252994090977502f, -0.00363228133247420f, -0.00184680864818596f, 0.00270668808271615f, 0.00685558665059282f, 0.00794079641258116f, 0.00478843277933532f, -0.00194573242678950f, -0.0101255056328730f, -0.0169970908725220f, -0.0202202610795858f, -0.0186900441328536f, -0.0128727709618177f, -0.00457129264113444f, 0.00375869978760271f, 0.00986987182678594f},
  {-0.0158635630778934f, -0.0118982542820018f, 0.000747058072935385f, 0.0145281424123965f, 0.0202293658783336f, 0.0137331877310236f, -0.000680011716756494f, -0.0133325910419249f, -0.0163521167416621f, -0.00946393040541374f, 0.000321638456932633f, 0.00495590552060028f, 0.00236690985703129f, -0.00183688777065241f, 0.000190248059471058f, 0.0103007529710772f, 0.0206896669070295f, 0.0190263299122238f, -0.000644384189019466f, -0.0299296693562918f, -0.0487874077710074f, -0.0389484059636668f, 0.000846432372064383f, 0.0497647425292439f, 0.0758305280502250f, 0.0571887986366839f, -0.000704719097061710f, -0.0651322465962297f, -0.0953582722452290f, -0.0693199899485542f, 0.000272569742576701f, 0.0722371935074672f, 0.102474740057641f, 0.0722371935074672f, 0.000272569742576701f, -0.0693199899485542f, -0.0953582722452290f, -0.0651322465962297f, -0.000704719097061710f, 0.0571887986366839f, 0.0758305280502250f, 0.0497647425292439f, 0.000846432372064383f, -0.0389484059636668f, -0.0487874077710074f, -0.0299296693562918f, -0.000644384189019466f, 0.0190263299122238f, 0.0206896669070295f, 0.0103007529710772f, 0.000190248059471058f, -0.00183688777065241f, 0.00236690985703129f, 0.00495590552060028f, 0.000321638456932633f, -0.00946393040541374f, -0.0163521167416621f, -0.0133325910419249f, -0.000680011716756494f, 0.0137331877310236f, 0.0202293658783336f, 0.0145281424123965f, 0.000747058072935385f, -0.0118982542820018f, -0.0158635630778934f},
  {0.0114411090717854f, 0.0165380572273883f, 0.00240846835883626f, -0.0163965874381038f, -0.0176891007986231f, 0.000837768723362836f, 0.0177940468307927f, 0.0142399801628911f, -0.00343634923966923f, -0.0134193780447341f, -0.00707496348576476f, 0.00254778774000949f, 0.00241634369292907f, -0.00135722682789177f, 0.00428039149952701f, 0.0141478042250982f, 0.00770357574636662f, -0.0181047047439228f, -0.0333191954593418f, -0.00877830572701143f, 0.0379324138679590f, 0.0509493824663633f, 0.00269410454669772f, -0.0607013224679361f, -0.0628582244186276f, 0.0103487762707755f, 0.0819600119445723f, 0.0660992394206584f, -0.0279199921263261f, -0.0970672310492389f, -0.0599008502071564f, 0.0459521242739052f, 0.102534171437945f, 0.0459521242739052f, -0.0599008502071564f, -0.0970672310492389f, -0.0279199921263261f, 0.0660992394206584f, 0.0819600119445723f, 0.0103487762707755f, -0.0628582244186276f, -0.0607013224679361f, 0.00269410454669772f, 0.0509493824663633f, 0.0379324138679590f, -0.00877830572701143f, -0.0333191954593418f, -0.0181047047439228f, 0.00770357574636662f, 0.0141478042250982f, 0.00428039149952701f, -0.00135722682789177f, 0.00241634369292907f, 0.00254778774000949f, -0.00707496348576476f, -0.0134193780447341f, -0.00343634923966923f, 0.0142399801628911f, 0.0177940468307927f, 0.000837768723362836f, -0.0176891007986231f, -0.0163965874381038f, 0.00240846835883626f, 0.0165380572273883f, 0.0114411090717854f},
  {0.000600284908252139f, -0.0171761223378898f, -0.00610824698095375f, 0.0175844949427824f, 0.0118162867169738f, -0.0145385642735737f, -0.0155332434667128f, 0.00897414281966385f, 0.0154351176465715f, -0.00302851202367092f, -0.0108111510109104f, -0.000521234744898018f, 0.00253068616932981f, -0.000869363570537383f, 0.00696663968860203f, 0.00858885844627725f, -0.0142127173512932f, -0.0221999864543959f, 0.0156665078092263f, 0.0392723373625850f, -0.00881670468157557f, -0.0558240235878783f, -0.00690619909726138f, 0.0672903410736166f, 0.0297114072797139f, -0.0697631946801383f, -0.0556906521812587f, 0.0611431912398211f, 0.0796936938747615f, -0.0418534377631013f, -0.0966112280018941f, 0.0148823228950620f, 0.102706508343789f, 0.0148823228950620f, -0.0966112280018941f, -0.0418534377631013f, 0.0796936938747615f, 0.0611431912398211f, -0.0556906521812587f, -0.0697631946801383f, 0.0297114072797139f, 0.0672903410736166f, -0.00690619909726138f, -0.0558240235878783f, -0.00881670468157557f, 0.0392723373625850f, 0.0156665078092263f, -0.0221999864543959f, -0.0142127173512932f, 0.00858885844627725f, 0.00696663968860203f, -0.000869363570537383f, 0.00253068616932981f, -0.000521234744898018f, -0.0108111510109104f, -0.00302851202367092f, 0.0154351176465715f, 0.00897414281966385f, -0.0155332434667128f, -0.0145385642735737f, 0.0118162867169738f, 0.0175844949427824f, -0.00610824698095375f, -0.0171761223378898f, 0.000600284908252139f},
  {-0.0122556444952426f, 0.0133000034758507f, 0.00961149511062668f, -0.0185333917221406f, -0.00371279074745663f, 0.0201828763968970f, -0.00322257268369246f, -0.0172438567842698f, 0.00809399058146180f, 0.0107025594876581f, -0.00815313053525404f, -0.00347765741489526f, 0.00229271773982744f, -0.000472781780574755f, 0.00814302433345242f, -0.00237478297470612f, -0.0194248326980401f, 0.0135752947562985f, 0.0264704284618307f, -0.0317233330012143f, -0.0245558027799328f, 0.0524543005558058f, 0.0111252212554405f, -0.0695468138644079f, 0.0129711192457784f, 0.0768237931548151f, -0.0433205736515932f, -0.0702271156741067f, 0.0730147241468597f, 0.0493359396581268f, -0.0946409692621715f, -0.0177623095686121f, 0.102551683253453f, -0.0177623095686121f, -0.0946409692621715f, 0.0493359396581268f, 0.0730147241468597f, -0.0702271156741067f, -0.0433205736515932f, 0.0768237931548151f, 0.0129711192457784f, -0.0695468138644079f, 0.0111252212554405f, 0.0524543005558058f, -0.0245558027799328f, -0.0317233330012143f, 0.0264704284618307f, 0.0135752947562985f, -0.0194248326980401f, -0.00237478297470612f, 0.00814302433345242f, -0.000472781780574755f, 0.00229271773982744f, -0.00347765741489526f, -0.00815313053525404f, 0.0107025594876581f, 0.00809399058146180f, -0.0172438567842698f, -0.00322257268369246f, 0.0201828763968970f, -0.00371279074745663f, -0.0185333917221406f, 0.00961149511062668f, 0.0133000034758507f, -0.0122556444952426f},
  {0.0157463896124725f, -0.00634240842512460f, -0.0122560614697531f, 0.0193578960372632f, -0.00565253839505790f, -0.0143702385913480f, 0.0186543872970696f, -0.00356072035737050f, -0.0126175342636703f, 0.0128233708674441f, -0.00116331890804869f, -0.00561973462277193f, 0.00212159555170581f, 6.84594558794798e-05f, 0.00712109463586430f, -0.0120836454691688f, -0.00129433606361364f, 0.0249256177149891f, -0.0275531371676901f, -0.00618402274153367f, 0.0459034348044579f, -0.0416467548887877f, -0.0146775031845038f, 0.0672193219441317f, -0.0519131383141347f, -0.0258470029030788f, 0.0856165248565287f, -0.0566479242524900f, -0.0378800637052381f, 0.0980816112011641f, -0.0552753618971410f, -0.0484538688535784f, 0.102491494123789f, -0.0484538688535784f, -0.0552753618971410f, 0.0980816112011641f, -0.0378800637052381f, -0.0566479242524900f, 0.0856165248565287f, -0.0258470029030788f, -0.0519131383141347f, 0.0672193219441317f, -0.0146775031845038f, -0.0416467548887877f, 0.0459034348044579f, -0.00618402274153367f, -0.0275531371676901f, 0.0249256177149891f, -0.00129433606361364f, -0.0120836454691688f, 0.00712109463586430f, 6.84594558794798e-05f, 0.00212159555170581f, -0.00561973462277193f, -0.00116331890804869f, 0.0128233708674441f, -0.0126175342636703f, -0.00356072035737050f, 0.0186543872970696f, -0.0143702385913480f, -0.00565253839505790f, 0.0193578960372632f, -0.0122560614697531f, -0.00634240842512460f, 0.0157463896124725f},
  {-0.00897857569264453f, -0.00258128605429599f, 0.0147912016792045f, -0.0197069879248466f, 0.0134738699584335f, 0.000571373623104392f, -0.0138481227654219f, 0.0183900600078018f, -0.0123992398051172f, 0.00128892821962681f, 0.00669557606606430f, -0.00698237299933053f, 0.00216411838187098f, 0.000510444765701973f, 0.00410218383132986f, -0.0134816302425906f, 0.0181299819268222f, -0.00892060844604389f, -0.0140369907899253f, 0.0382925303766589f, -0.0455395396128622f, 0.0244897295719198f, 0.0186535687557421f, -0.0605692398527129f, 0.0737073642262985f, -0.0444262295238690f, -0.0156556809364605f, 0.0738235235964047f, -0.0948796430413683f, 0.0631863273453218f, 0.00607986859424931f, -0.0744748847123034f, 0.102745006715041f, -0.0744748847123034f, 0.00607986859424931f, 0.0631863273453218f, -0.0948796430413683f, 0.0738235235964047f, -0.0156556809364605f, -0.0444262295238690f, 0.0737073642262985f, -0.0605692398527129f, 0.0186535687557421f, 0.0244897295719198f, -0.0455395396128622f, 0.0382925303766589f, -0.0140369907899253f, -0.00892060844604389f, 0.0181299819268222f, -0.0134816302425906f, 0.00410218383132986f, 0.000510444765701973f, 0.00216411838187098f, -0.00698237299933053f, 0.00669557606606430f, 0.00128892821962681f, -0.0123992398051172f, 0.0183900600078018f, -0.0138481227654219f, 0.000571373623104392f, 0.0134738699584335f, -0.0197069879248466f, 0.0147912016792045f, -0.00258128605429599f, -0.00897857569264453f}
};

static float32_t eqGains32[EQ_NUM_OF_FILTERS] =                  // Multiplier of each equaliser (EQ_NUM_OF_FILTERS bands).
{
  1.0f, 1.0f, 1.0f, 1.0f, 1.0f, 1.0f, 1.0f, 1.0f
};

static float32_t outputAux[NUM_TAPS];

/*******************************************************************************
 *******************************************************************************
                        GLOBAL FUNCTION DEFINITIONS
 *******************************************************************************
 ******************************************************************************/

void eqInit(uint32_t frameSize)
{	
	// Call FIR init function to initialise the instance structure.
	for (uint32_t j=0; j < EQ_NUM_OF_FILTERS; j++)
	{
		arm_fir_init_f32(&(parallelFilter[j]), NUM_TAPS, (float32_t *)&eqFirCoeffs32[0], &firStateF32[0], blockSize);
	}

  eqFrameSize = frameSize;
}

void eqFilterFrame(float32_t * inputF32, float32_t * outputF32)
{ 
	// Call the FIR process function for every blockSize samples.
	for (uint32_t i=0; i < eqFrameSize/BLOCK_SIZE; i++)
	{
	  for (uint32_t j=0; j < EQ_NUM_OF_FILTERS; j++)
	  {
	  	arm_fir_f32(&(parallelFilter[j]), inputF32 + (i * BLOCK_SIZE), outputAux, blockSize);
	  	for (uint32_t k=0; k < BLOCK_SIZE; k++)
	  	{
	  		outputF32[k + (i * BLOCK_SIZE)] += eqGains32[k] * outputAux[k];
	  	}
	  }
	}
}

void eqSetFilterGains(float32_t gains[EQ_NUM_OF_FILTERS])
{
  for (uint32_t i=0; i < EQ_NUM_OF_FILTERS; i++)
  {
    eqGains32[i] = gains[i];
  }
}

void eqSetFilterGain(float32_t gain, uint8_t filterNum)
{
  eqGains32[filterNum] = gain;
}

